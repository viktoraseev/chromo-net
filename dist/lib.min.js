!function(n,e,t){function o(){}function r(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function i(){var n=navigator.userAgent,e=n.match(/MSIE\s([\d.]+)/)||n.match(/Trident\/[\d](?=[^\?]+).*rv:([0-9.].)/),t=n.match("Edge/([0-9]{1,}[.0-9]{0,})");return{storageEvent:!t,topStorage:!(!e||"11"!=e[1]),blob:!e,msgSize:4e3}}function s(n){function e(){for(var e=Object.keys(t),o=e.length,r=0;o>r;r++){var i=e[r];0===i.lastIndexOf(n,0)&&t.removeItem(i)}}var o=setInterval(e,5e3);this.shutdown=function(){e(),clearInterval(o)}}function c(n){function e(n){if(!n)throw new Error("State could not be empty");var e=l;l&&l.leave(e,n),l=n,n.enter(e,n)}function t(n,e,t){l.onMessage(n,e,t)}function i(n,e,t){s("message",{data:n,sender:e})}function s(n,e){var t=p[n];if(t)try{t(e)}catch(o){console.error("Error during handing event "+n,o)}}function c(n){var t=this;t.onMessage=o,t.enter=function(t,o){h&&h.shutdown(),w=null,h=null,s("disconnected",{type:"disconnected"}),n&&e(new d)},t.name=function(){return"Disconnected"},t.leave=o,t.send=function(n,e){throw new Error("Could not send data while Disconnected")}}function d(i){function c(){if(!d)if(d=!0,a.length>0){a.push({id:w});var n=a.map(function(n){return n.id}).sort();e(n[0]===w?new f:new u(n[0]))}else e(new f)}var a,d,l=this;l.onMessage=function(n,e,t){if(n.t===m)h.send({t:C,host:!1},e);else if(n.t===C)a.push({id:e,host:n.host}),n.host;else if(n.t==E)h.send({t:S},e);else if(n.t!==S)throw new Error("Unsupported message at ConnectingState "+n.t)},l.enter=function(e,o){if(!i&&w)throw new Error("Unexpected state, id should be null");if(i&&!w)throw new Error("Unexpected state, id should be not null");i||(w=+Date.now()+"-"+r(),h=new ChromonetUdpChannel(n,w,t)),h.send({t:m}),a=[],setTimeout(c,M),s("connecting",{type:"connecting",id:w})},l.name=function(){return"Connecting"},l.leave=o,l.send=function(n,e){throw new Error("Could not send data while Connecting")}}function u(t){function o(){g||e(new d(!0))}var r,c=this;c.onMessage=function(n,e,t){if(n.t===m)h.send({t:C,host:!1},e);else if(n.t==E)h.send({t:S},e);else if(n.t===S)pingService.pong();else if(n.t===C);else{if(n.t!==y)throw new Error("unknown message at ClientState "+n.t);g=n.mode,console.log("Changed freezeMode to: "+g+", for "+w)}},c.enter=function(e,c){r=new ChromonetUdpChannel(n+"client",w,i),pingService=new a(h,t,o),s("client",{type:"client",id:w,host:t})},c.name=function(){return"Client"},c.leave=function(n,e){pingService.shutdown(),r.shutdown()},c.send=function(n,e){r.send(n,e)}}function f(){var e,t=this;t.onMessage=function(n,e,t){if(n.t===m)h.send({t:C,host:!0},e);else if(n.t==E)h.send({t:S},e);else if(n.t===S);else if(n.t===C);else{if(n.t!==y)throw new Error("unknown message at HostState "+n.t);g=n.mode,console.log("Changed freezeMode to: "+g+", for "+w)}},t.enter=function(t,o){e=new ChromonetUdpChannel(n+"client",w,i),s("host",{type:"host",id:w})},t.name=function(){return"Host"},t.leave=function(n,t){e.shutdown()},t.send=function(n,t){e.send(n,t)}}var h,l,w,g,v=this,p={},m="reportPlz",C="reportHere",E="ping",S="pong",y="freeze",M=550;v.connect=function(){if("Disconnected"!==l.name())throw new Error("Already connected or connecting");e(new d)},v.disconnect=function(){if("Disconnected"===l.name())throw new Error("Already disconnected");e(new c)},v.send=function(n,e){l.send(n,e)},v.setEventListener=function(n,e){p[n]=e},v.id=function(){return w},v.freeze=function(n){return"undefined"!=typeof n&&(g=!!n,console.log("Changed freezeMode to: "+g+", for "+w),h.send({t:y,mode:g})),g},v.serviceChannel=function(){return h},e(new c)}function a(n,e,t){function o(){return s&&Date.now()-s>3*i?void t():void n.send({t:r},e)}var r="ping",i=700,s=Date.now(),c=setInterval(o,i);this.shutdown=function(){clearInterval(c)},this.pong=function(){s=Date.now()}}function d(n,e){this.connect=function(n,e,t){},this.send=function(n,e){}}function u(o,r,i){function c(n){var t=n.key;if(t!==h&&0===t.lastIndexOf(o+"-",0)){var r;try{var i=n.newValue;if(!i)return;r=JSON.parse(i)}catch(s){return void e.error(s)}r&&(!r.t||r.t&&r.t===h)&&w[t]!==r.c&&(w[t]=r.c,d(r.d,t.substring(u)))}}var a=this,d=i;if(!r)throw new Error("id is not specified");if(!o)throw new Error("channel is not specified");var u=o.length+1,h=o+"-"+r,l=0,w={},g=new s(o);a.setEventListener=function(n,e){if("message"!==n)throw new Error('Only "message" type is supported');d=e},a.send=function(n,e){var r={c:l++,d:n};e&&(r.t=o+"-"+e),t.setItem(h,JSON.stringify(r))},a.shutdown=function(){g.shutdown(),f.topStorage?n.top.removeEventListener("storage",c,!1):n.removeEventListener("storage",c,!1)},f.topStorage?n.top.addEventListener("storage",c,!1):n.addEventListener("storage",c,!1)}var f=i();n.ChromonetChannelCleaner=s,n.Chromonet=c,n.ChromonetPing=a,n.ChromonetTcpChannel=d,n.ChromonetUdpChannel=u}(window,console,localStorage);